<!-- Prematurely connect to the servers to save some milliseconds -->
<!-- <link rel="preload"> is only in recent browser versions, so we keep "dns-prefetch" and "preconnect" -->
<!-- <link rel="prefetch" loads content the user may request *after* the page loads -->

{{- with $.Site.Params.thumbnail -}}
<meta name="thumbnail" content="{{ partial "make_link" . }}" />
{{- end -}}

{{ partial "fontawesome/head.html" . }}

{{ partial "matomo/head.html" . }}

{{ partial "iubenda/head.html" . }}

{{- .Scratch.Set "sitevar" $.Site -}}
{{- partial "css/color/parse_color.css" .Scratch -}}
{{- .Scratch.Set "label" "alt_bg" -}}
{{- partial "css/color/detect_light_or_dark.css" .Scratch -}}

{{- if ($.Scratch.Get "alt_bg_is_dark") -}}
    {{- .Scratch.Set "code_css" (partial "get_min_url" (dict "URL" "/css/dark%s.css" "Site" $.Site)) }}
{{- else -}}
    {{- .Scratch.Set "code_css" (partial "get_min_url" (dict "URL" "/css/light%s.css" "Site" $.Site)) }}
{{- end -}}

{{ partial "async/css.html" (dict "URL" (.Scratch.Get "code_css")) }}

{{ partial "async/css.html" (dict "URL" (partial "make_link" "styles.css")) }}

{{ $files := slice "foundation" "reset" "fonts" "classes" "page" "widgets" }}
{{ range $f := $files }}
    {{ $file := partial "get_min_url" (dict "URL" (printf "css/%s%%s.css" $f) "Site" $.Site) }}
    {{ partial "async/css.html" (dict "URL" $file) }}
{{ end }}

{{ if eq .Kind "page" }}
{{ partial "async/css.html" (dict "URL" (partial "get_min_url" (dict "URL" "css/single%s.css" "Site" $.Site))) }}
{{ else }}
{{ partial "async/css.html" (dict "URL" (printf "css/list%s.css" (cond ($.Site.Params.no_minimize | default false) "" ".min"))) }}
{{ end }}

{{ if .Content -}}
    {{ $figures := findRE "<figure" .Content -}}
    {{ $forms := findRE "<input" .Content -}}
    {{ $tables := findRE "<table" .Content -}}
    
    {{ if gt (len $figures) 0 }}
    {{ partial "async/css.html" (dict "URL" (partial "get_min_url" (dict "URL" "css/figure%s.css" "Site" $.Site))) }}
    {{ end }}
    
    {{ if or (gt (len $forms) 0) $.Site.Params.comments.provider }}
    {{ partial "async/css.html" (dict "URL" (partial "get_min_url" (dict "URL" "css/forms%s.css" "Site" $.Site))) }}
    {{ end }}
    
    {{ if gt (len $tables) 0 }}
    {{ partial "async/css.html" (dict "URL" (partial "get_min_url" (dict "URL" "css/table%s.css" "Site" $.Site))) }}
    {{ end }}
{{ end -}}

{{ if $.Site.Params.iubenda.id }}
{{ partial "async/css.html" (dict "URL" (partial "get_min_url" (dict "URL" "css/iubenda%s.css" "Site" $.Site))) }}
{{ end }}

<link rel="preload" media="print" type="text/css" href="{{ partial "get_min_url" (dict "URL" "css/print%s.css" "Site" $.Site) }}" as="style">

{{ partial "async/cssrelpreload.js.html" }}

{{- partial "shortcodes/partial.html" (dict "Prop" "head" "Root" $) -}}

{{- partial "sidebar/partial.html" (dict "Prop" "head" "Root" $) -}}

{{- partial "comments/partial.html" (dict "Prop" "head" "Root" $) -}}

{{ if .Content -}}
    {{ $urls := findRE "<img src=\"[^\"|\\\"]*\"" .Content -}}
    {{ range $url := $urls -}}
      {{ $url := (strings.TrimPrefix "<img src=\"" $url) -}}
      {{ $url := strings.TrimSuffix "\"" $url -}}
      <link rel="preload" href="{{ $url | htmlUnescape | safeHTML }}" as="image" />
    {{ end -}}
{{ end -}}

{{ partial "matomo/head2.html" . }}

{{- partial "favicons.html" . -}}
